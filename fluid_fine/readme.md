# Fluid-structure optimization problem with 40x16 variables


## Software environment
* COMSOL Multiphysics 5.4
* Matlab 2019b
* Python 3.7
  * PyTorch 1.2.0

## Code
* <strong>fluid.m</strong>: MATLAB script to generate a COMSOL file, used to calculate pressure based on given density distribution
* <strong>fluid_optimized.m</strong>: MATLAB script to generate a COMSOL file, used to calculate optimal configuration based on MMA and the adjoint
  method

* <strong>func_*.m</strong>: MATLAB function scripts
  * <strong>func_inputs_gen.m</strong>: a function to generate input data, i.e., $\rho$ in paper
  * <strong>func_outputs_nowrite.m</strong>: a function to calculate output, i.e., reciprocal of pressure, 1/P
  * <strong>func_test.m</strong>: a function to evaluate the optimized solution $\hat{\rho}$ from DNN
  * Others are used to plot

* <strong>main_*.m</strong>: MATLAB code to generate data
  * <strong>main_greedy.m</strong>: code to implement our proposed SOLO-G algorithm, and generate data in subfolder "data_g"
  * <strong>main_regular.m</strong>: code to implement our proposed SOLO-R algorithm, and generate data in subfolder "data_r"

* <strong>plot_*.m</strong>: MATLAB code to plot the data
  * <strong>plot_c.m</strong>: plot figure c
  * <strong>plot_b_d.m</strong>: plot figures b, and d
  * <strong>plot_s\[5,8,9\].m</strong>: plot Supplementary Figure \[5,8,9\]


* <strong>bba.py</strong>: python code to implement Binary Bat Algorithm (BBA)

* <strong>utils.py</strong>: python utility code to check whether a design is feasible (fluid is not blocked by solid)

* <strong>mlopt.py</strong>: (abbreviation of Machine Learning and OPTimization) python code to train a Deep Learning Network (DNN) and obtain the
  optimized solution based on the DNN by BBA

## Data

If you run the code, data will be generated and stored in subfolder:

* <strong>data_g</strong>: data generated by the code "main_greedy.m" for SOLO-G

If you change the random seeds and the output folder names, you can also get __data_g[2-5]__.

You can also get:

* <strong>data_gb.mat</strong>: data generated by "plot_c.m" for the gradient-based method
* <strong>data_pert.mat</strong>: data generated by "plot_s6.m" for the perturbation of the optimum from SOLO-G to check the gaps

Data is not uploaded to Github. Please download
from [Google Drive](https://drive.google.com/drive/folders/1f6Xrd9e-RAUsh9vqIqUXbEw8F1_2Qg_5?usp=sharing) or email us.

## How to run

1. Connect MATLAB with COMSOL server
2. Run __fluid.m__ by COMSOL to generate __fluid.mph__
3. Run __main_greedy.m__
4. [optional] Run __plot_b_d.m__ and __plot_s\[5,8,9\].m__
5. Run __fluid_optimized.m__ by COMSOL to generate __fluid_optimized.mph__
6. [optional] Run __plot_c.m__

As long as a __*.m__ file says `Comsol server required` in the comment at the top, you need to connect the MATLAB with a COMSOL server to run the
file. I recommend adding parameters `-autosave off -np 1 -multi on` (`-autosave off` turns off autosave, `-np 1` sets number of CPU cores of each
server to 1, and
`-multi on` keeps the server after disconnecting COMSOL from MATLAB). You could add to target if you use Shortcut to start the server or to the
command if using command line to start.