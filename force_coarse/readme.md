# Compliance minimization problem with 5x5 variables


## Software environment
* COMSOL Multiphysics 5.4
* Matlab 2019b
* Python 3.7
  * SciPy 1.2.0
  * PyTorch 1.2.0
  * Optuna 2.0.0

  
For SciPy: please be aware that there was an [issue](https://github.com/scipy/scipy/issues/10892) in simulated annealing function `dual_annealing ` when I ran the code using this package. It has been fixed in 1.6.0. Difference is expected in the behavior, but should not be too much. You can tune the paramters of the function to reduce the difference, although not necessary.
## Code
* <strong>force.m</strong>: MATLAB script to generate a COMSOL file, used to calculate elastic energy based on given density distribution
* <strong>force_optimized.m</strong>: MATLAB script to generate a COMSOL file, used to calculate optimal configuration based on MMA

* <strong>func_*.m</strong>: MATLAB function scripts
  * <strong>func_inputs_gen.m</strong>: a function to generate input data, i.e., $\rho$ in paper
  * <strong>func_outputs.m</strong>: a function to calculate output, i.e., reciprocal of energy, 1/E
  * <strong>func_test.m</strong>: a function to evaluate the optimized solution $\hat{\rho}$ from DNN
  * <strong>func_python_api.m</strong>: an API to connect Python with MATLAB
  * Others are used to plot

* <strong>main_*.m</strong>: MATLAB code to generate data
  * <strong>main_solo.m</strong>: code to implement our proposed SOLO algorithm, and generate data in subfolder "data_solo"
  * <strong>main_offline.m</strong>: code to implement "Offline" algorithm, and generate data in subfolder "data_offline"
  * <strong>main_bo.m</strong>: code to implement Bayesian Optimization (BO) algorithm, and generate data in "data_bo.mat"
  * <strong>main_ss.m</strong>: code to implement Stochastic Search (SS) algorithm, and generate data in "data_ss.mat"

* <strong>plot_*.m</strong>: MATLAB code to plot the data
  * <strong>plot_b_c.m</strong>: plot figures b and c
  * <strong>plot_d_e_f.m</strong>: plot figures d, e, and f
  * <strong>plot_s1.m</strong>: plot Supplementary Figure 1
  * <strong>plot_s2.m</strong>: plot Supplementary Figure 2

* <strong>main_cmaes.py</strong>: python code to implement Covariance Matrix Adaptation Evolution Strategy (CMA-ES), and generate "data_cmaes.mat"

* <strong>main_gsa.py</strong>: python code to implement Generative Simulated Annealing (GSA) directly without using DNN, and generate "data_gsa.mat"

* <strong>mlopt.py</strong>: (abbreviation of Machine Learning and OPTimization) python code to train a Deep Learning Network (DNN) and obtain the optimized solution based on the DNN by Generative Simulated Annealing (GSA)

## Data
If you run the code, data will be generated and stored in subfolders:
* <strong>data_offline</strong>: data generated by the code "main_offline.m" for "Offline"
* <strong>data_solo</strong>: data generated by the code "main_solo.m" for SOLO

You will also get files:
* <strong>data_bo.mat</strong>: data generated by the code "main_bo.m" for BO
* <strong>data_ss.mat</strong>: data generated by the code "main_ss.m" for SS
* <strong>data_cmaes.mat</strong>: data generated by "main_cmaes.py" for CMA-ES
* <strong>data_gsa.mat</strong>: data generated by "main_gsa.py" for GSA

Data is not uploaded to Github. Please download from [Google Drive](https://drive.google.com/drive/folders/1f6Xrd9e-RAUsh9vqIqUXbEw8F1_2Qg_5?usp=sharing) or email us.

## How to run
1. Connect MATLAB with COMSOL server
2. Run __force.m__ by COMSOL to generate __force.mph__
3. Run __main_offline.m__, __main_SOLO.m__,  __main_bo.m__, and __main_ss.m__
4. Prepare with connet Python to MATLAB (which has connected to COMSOL server). You need to install MATLAB API for Python (
   see [doc](https://www.mathworks.com/help/matlab/matlab_external/install-the-matlab-engine-for-python.html)) and then
   run `matlab.engine.shareEngine` on MATLAB. Other ways are also feasible, as long as Python can be connected to MATLAB.
5. Run <strong>main_cmaes.py</strong> and <strong>main_gsa.py</strong>
6. [optional] Run __plot_b_c.m__ and __plot_s1.m__ and __plot_s2.m__
7. Run __force_optimized.m__ by COMSOL to generate __force_optimized.mph__
8. [optional] Run __plot_d_e_f.m__

As long as a __*.m__ file says `Comsol server required` in the comment at the top, you need to connect the MATLAB with a COMSOL server to run the
file. I recommend adding parameters `-autosave off -np 1 -multi on` (`-autosave off` turns off autosave, `-np 1` sets number of CPU cores of each
server to 1, and
`-multi on` keeps the server after disconnecting COMSOL from MATLAB). You could add to target if you use Shortcut to start the server or to the
command if using command line to start.